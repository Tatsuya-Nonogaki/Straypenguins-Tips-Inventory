# Creates a PR that applies the multi-user (userN) patches to cloudinit-linux-vm-deploy.ps1
# Run manually from Actions -> Workflows -> "Create PR: multi-user support" -> Run workflow
name: Create PR: multi-user support

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Create working branch
        id: create_branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH="feat/multi-user-support-$(date +%s)"
          git checkout -b "${BRANCH}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Apply patch (v75/v76)
        run: |
          cat > changes.patch <<'PATCH'
*** Begin Patch
*** Update File: vSphere/cloudinit-vm-deploy/cloudinit-linux-vm-deploy.ps1
@@
 try {
     $params = ConvertFrom-Yaml (Get-Content $Config -Raw)
 } catch {
     Write-Log -Error "Failed to parse configuration parameter YAML: $Config"
     Exit 3
 }
 
 $new_vm_name = $params.new_vm_name
+
+# --- Begin: map "userN" hashes to legacy top-level username/password for compatibility ---
+# Find keys like user1, user2 ... and sort numerically
+$userKeys = @()
+try {
+    $userKeys = $params.Keys | Where-Object { $_ -match '^user\d+$' } | Sort-Object { [int]($_ -replace '^user','') }
+} catch {
+    $userKeys = @()
+}
+
+if ($userKeys.Count -gt 0) {
+    # Choose the first user with primary=true; otherwise fall back to the first declared user.
+    $primaryUser = $null
+    foreach ($k in $userKeys) {
+        $u = $params[$k]
+        if ($u -and $u.primary) {
+            $primaryUser = $u
+            break
+        }
+    }
+    if (-not $primaryUser) {
+        $primaryUser = $params[$userKeys[0]]
+    }
+
+    if ($primaryUser) {
+        # Only map username/password for in-guest operations (keep other userN fields untouched
+        # so Replace-Placeholders can render user-data from user1.*, user2.*, etc.)
+        if ($primaryUser.name)     { $params.username = $primaryUser.name }
+        if ($primaryUser.password) { $params.password = $primaryUser.password }
+
+        Write-Log "Primary user selected for in-guest operations: '$($params.username)'" -Verbose
+    }
+}
+# --- End compatibility mapping ---
*** End Patch
PATCH
          # apply first hunk
          git apply changes.patch || ( echo "git apply failed"; cat changes.patch; exit 1 )
          # second patch (insert per-user SSH_KEYS replacement after existing SSH_KEYS handling)
          cat > changes2.patch <<'PATCH'
*** Begin Patch
*** Update File: vSphere/cloudinit-vm-deploy/cloudinit-linux-vm-deploy.ps1
@@
                 $template = $template -replace '\{\{SSH_KEYS\}\}', $sshKeysBlock
                 Write-Log "SSH_KEYS placeholder replaced (count: $($params.ssh_keys.Count))"
+                
+                # --- Begin: per-user SSH_KEYS replacement (support user1, user2, ... definitions) ---
+                $userKeys = $params.Keys | Where-Object { $_ -match '^user\d+$' } | Sort-Object { [int]($_ -replace '^user','') }
+                foreach ($userKey in $userKeys) {
+                    $u = $params[$userKey]
+                    if (-not $u) { continue }
+
+                    if ($u.ssh_keys -and $u.ssh_keys.Count -gt 0) {
+                        # Indentation must match the template: ssh_authorized_keys: is above and its items are expected with six spaces (adjust if your template differs).
+                        $sshLines = $u.ssh_keys | ForEach-Object { '      - "' + $_.ToString().Trim() + '"' }
+                        $userSshBlock = $sshLines -join "`n"
+                    } else {
+                        # Emit an explicit empty array to keep YAML valid and remove need for commented-out items
+                        $userSshBlock = '      []'
+                    }
+
+                    $placeholder = "${userKey}.SSH_KEYS"
+                    $pattern = '\{\{\s*' + [Regex]::Escape($placeholder) + '\s*\}\}'
+
+                    if ($template -match $pattern) {
+                        Write-Verbose "Replacing per-user SSH placeholder: '$placeholder'"
+                        $template = $template -replace $pattern, $userSshBlock
+                        Write-Log "SSH_KEYS placeholder for $userKey replaced (count: $($u.ssh_keys.Count))"
+                    }
+                }
+                # --- End per-user SSH_KEYS replacement ---
*** End Patch
PATCH
          git apply changes2.patch || ( echo "git apply failed for second patch"; cat changes2.patch; exit 1 )
          git add vSphere/cloudinit-vm-deploy/cloudinit-linux-vm-deploy.ps1
          git commit -m "feat: support user1..userN definitions and per-user SSH_KEYS; map primary user to username/password"
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"

      - name: Push branch
        run: |
          BRANCH="${{ steps.create_branch.outputs.branch }}"
          git push --set-upstream origin $BRANCH

      - name: Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: support user1..userN definitions and per-user SSH_KEYS; map primary user to username/password"
          title: "feat: support multiple users (userN) and per-user SSH_KEYS; map primary user"
          body: |
            This PR adds minimal changes to:
            - Map a selected primary user (userN.primary) to top-level username/password for in-guest operations.
            - Add per-user {{userN.SSH_KEYS}} replacement in user-data template rendering.

            See discussion in issue/PR (internal) for rationale. Please review and run test rendering with your draftc1 params/template.
          base: main
          branch: ${{ steps.create_branch.outputs.branch }}
          labels: automatic, infra
