# The top level settings are used as module
# and base configuration.

# ====== vSphere Cloud-init Linux VM Deployment Kit optimized ======
# - Suppress implicit default user creation (users: [])
# - Root SSH login allowed by default (disable_root: false)
# - Hostname preservation: true (overridden per-clone in 99-override.cfg)
# - SSH host keys are always deleted/regenerated by cloud-init (for security, RHEL9 default key types)
# - No default package update/upgrade in final phase
# - All modules set to once-per-instance or once to avoid repeated execution after initial deployment
# - All other logic follows RHEL9 cloud-init default unless otherwise noted
# ================================================================

# A set of users which may be applied and/or used by various modules
# when a 'default' entry is found it will reference the 'default_user'
# from the distro configuration specified below
# [CHANGED] Suppress default user creation (no cloud-user)
users: []

# If this is set, 'root' will not be able to ssh in and they
# will get a message to login instead as the default $user
# [CHANGED] Allow root SSH login (set to false)
disable_root: false

mount_default_fields: [~, ~, 'auto', 'defaults,nofail,x-systemd.after=cloud-init-network.service,_netdev', '0', '2']
# [CHANGED] Do not disable SSH password authentication
#ssh_pwauth: false

# This will cause the set+update hostname module to not operate (if true)
# [CHANGED] Template VM: true (overridden by 99-override.cfg:false on clones)
preserve_hostname: true

# If you use datasource_list array, keep array items in a single line.
# If you use multi line array, ds-identify script won't read array items.
# Example datasource config
# datasource:
#   Ec2:
#     metadata_urls: [ 'blah.com' ]
#     timeout: 5 # (defaults to 50 seconds)
#     max_wait: 10 # (defaults to 120 seconds)

# Default redhat settings:
# [NOTE] Always delete and regenerate all SSH host keys on clone initialization
ssh_deletekeys: true
# [NOTE] Use all recommended key types (RHEL9 cloud-init default)
ssh_genkeytypes: ['rsa', 'ecdsa', 'ed25519']
syslog_fix_perms: ~
disable_vmware_customization: false

# The modules that run in the 'init' stage
cloud_init_modules:
  - [seed_random, once-per-instance]
  - [bootcmd, once-per-instance]
  - [write_files, once-per-instance]
  - [growpart, once-per-instance]
  - [resizefs, once-per-instance]
  - [disk_setup, once-per-instance]
  - [mounts, once-per-instance]
  - [set_hostname, once-per-instance]
  - [update_hostname, once-per-instance]
  - [update_etc_hosts, once-per-instance]
  - [ca_certs, once-per-instance]
  - [rsyslog, once-per-instance]
  - [users_groups, once-per-instance]
  - [ssh, once-per-instance]
  - [set_passwords, once-per-instance]

# The modules that run in the 'config' stage
cloud_config_modules:
  - [ssh_import_id, once-per-instance]
  - [locale, once-per-instance]
  - [rh_subscription, once-per-instance]
  - [spacewalk, once-per-instance]
  - [yum_add_repo, once-per-instance]
  - [ntp, once-per-instance]
  - [timezone, once-per-instance]
  - [disable_ec2_metadata, once-per-instance]
  - [runcmd, once-per-instance]

# The modules that run in the 'final' stage
# [CHANGED] Remove package_update_upgrade_install to avoid accidental package upgrades on clone
cloud_final_modules:
  - [write_files_deferred, once-per-instance]
  - [puppet, once-per-instance]
  - [chef, once-per-instance]
  - [ansible, once-per-instance]
  - [mcollective, once-per-instance]
  - [salt_minion, once-per-instance]
  - [reset_rmc, once-per-instance]
  - [scripts_vendor, once-per-instance]
  - [scripts_per_once, once]
  - [scripts_per_boot, once-per-instance]
  - [scripts_per_instance, once-per-instance]
  - [scripts_user, once-per-instance]
  - [ssh_authkey_fingerprints, once-per-instance]
  - [keys_to_console, once-per-instance]
  - [install_hotplug, once-per-instance]
  - [phone_home, once-per-instance]
  - [final_message, once-per-instance]
  - [power_state_change, once-per-instance]

# System and/or distro specific settings
# (not accessible to handlers/transforms)
system_info:
  # This will affect which distro class gets used
  distro: rhel
  # [CHANGED] Removed default_user stanza to fully suppress cloud-user creation
  # Default user name + that default users groups (if added/used)
  #default_user:
  #  name: cloud-user
  #  lock_passwd: True
  #  gecos: Cloud User
  #  groups: [adm, systemd-journal]
  #  sudo: ["ALL=(ALL) NOPASSWD:ALL"]
  #  shell: /bin/bash
  network:
    renderers: ['sysconfig', 'eni', 'netplan', 'network-manager', 'networkd']
  # Other config here will be given to the distro class and/or path classes
  paths:
    cloud_dir: /var/lib/cloud/
    templates_dir: /etc/cloud/templates/
  ssh_svcname: sshd
