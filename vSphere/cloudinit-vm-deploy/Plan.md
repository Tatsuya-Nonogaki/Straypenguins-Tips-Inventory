# è¨ˆç”»ãƒ»ä»•æ§˜æ›¸: cloud-init å¯¾å¿œ Linux VM Deployment Kit on vSphere
Rev.4

## ðŸŽ¯ å…¨èˆ¬çš„ãªã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

â˜‘ï¸ å½“ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚»ãƒƒãƒˆã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ã‚ˆã‚Šåºƒã„å±¤ã®äººã€…ã«ãŒä½¿ãˆã‚‹ã‚ˆã†ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã¯ã™ã¹ã¦è‹±èªžãƒ™ãƒ¼ã‚¹ã¨ã™ã‚‹ã€‚ãŸã ã—ã€READMEã®ã¿ã€ã‚ã¨ã§æ—¥æœ¬èªžç‰ˆã‚‚åˆ¶ä½œã™ã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚

â˜‘ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã¯ã™ã¹ã¦UTF-8ã¨ã™ã‚‹ã€‚æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã¯ã€Linuxä¸Šã§ä½¿ç”¨ã™ã‚‹ã‚‚ã®ã¯LF, Windowsä¸Šã§ä½¿ç”¨ã™ã‚‹ã‚‚ã®ã¯CRLFã¨ã™ã‚‹ã€‚  
**å…·ä½“çš„ã«ã¯:**  
- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ¬ä½“ `cloudinit-linux-vm-deploy.ps1` : CRLF
- ãã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `vm-settings*.yaml` : CRLF
- ãã‚Œä»¥å¤–ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ« : LF

â˜‘ï¸ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ Exitã‚³ãƒ¼ãƒ‰ åŸºæœ¬ãƒ«ãƒ¼ãƒ«

| ã‚³ãƒ¼ãƒ‰ | æ„å‘³                            | ä¾‹                     |
|--------|---------------------------------|------------------------|
| 0      | æ­£å¸¸çµ‚äº†                        |                        |
| 1      | ä¸€èˆ¬çš„ãªå®Ÿå‡¦ç†ã‚¨ãƒ©ãƒ¼            | VMæ“ä½œã€PowerCLIå¤±æ•—ç­‰ |
| 2      | ã‚·ã‚¹ãƒ†ãƒ /ç’°å¢ƒ/ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚¨ãƒ©ãƒ¼ | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆå¤±æ•—ç­‰ |
| 3      | å¼•æ•°ãƒ»å…¥åŠ›ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼   | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³/ä¸æ­£ç­‰  |

### ç’°å¢ƒãƒ»ã‚¹ãƒšãƒƒã‚¯

**Infrastructure**

- vSphere 8 u3+ vCSA & Hosts
  - SSO User: administrator@vsphere.local
  - SSO Password: KenFiat50s^
- ç®¡ç†ã‚µãƒ¼ãƒ
  - Windows Server 2019+
  - PowerShell 5.1
  - PowerCLI 13.3+

**Template VM**

- VMName: rhel9-tpl
- OS-Hostnane: rhel9-tpl
- FQDN: rhel9-tpl.backyard.local
- vSphere-Cluster: CLST_A (DRSãªã—)
- CPU: 2
- Mem: 3GB
- NIC: x1 ens192 (vmxnet3)
- vSphere-Network-Label: Backyard_LAN
- IP: 192.168.1.100/24 GW:.254 DNS:192.168.1.200
- OS: RHEL9(.4+)
- vSphere Datastore: BackyardStore
- Disks: ã„ãšã‚Œã‚‚é€šå¸¸ã®vmdk   
  1. sda 40GB : Partition#1:/boot/efi/, P#2:/boot, P#3:/ (æ®‹ã‚Šå…¨éƒ¨)
  2. sdb 2GB  : P#1:swap
  3. sdc 1GB  : P#1:kdump
- User: mainte
  - Password: CachDreik5
  - ssh-authorized-keys: ç™»éŒ²ãªã—

**Example VM (ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ)**

- VMName: original01
- OS-Hostnane: original01
- FQDN: original01.production.local
- vSphere-Cluster: CLST_A (DRSãªã—)
- ESXi-Host: vhost-a01
- CPU: 3
- Mem: 4GB
- NIC: x1 ens192 (vmxnet3)
- vSphere-Network-Label: PROD_LAN01
- IP: 192.168.0.10/24 GW:.254 DNS:192.168.0.201,192.168.0.202
- vSphere Datastore: ProdStore  
  ã„ãšã‚Œã‚‚growpartã™ã‚‹
  1. sda 45GB : Partition#1:/boot/efi/, P#2:/boot, P#3:/ (æ®‹ã‚Šå…¨éƒ¨)
  2. sdb 6GB  : P#1:swap
  3. sdc 5GB  : P#1:kdump
- User: mainte
  - Password: CachDreik5
  - ssh-authorized-keys: C:\work\ssh\id_rsa.pub
- ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚package_update: ã—ãªã„
- ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚package_upgrade: ã—ãªã„

---

## ðŸš€ å·¥ç¨‹ãƒ»é‹ç”¨ãƒ•ãƒ­ãƒ¼  

### æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º
**Template VM æ§‹ç¯‰**

- é€šå¸¸é€šã‚Šæ§‹ç¯‰: Red Hatã‚µãƒ–ã‚¹ã‚¯Register, ãƒ‘ãƒƒãƒé©ç”¨ç­‰  
  ï¼ˆâ‡’ RHã‚µãƒ–ã‚¹ã‚¯ã¯ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚¯ãƒ­ãƒ¼ãƒ³ä¸Šã§ã‚¯ãƒªã‚¢ï¼‰
- `cloud-init`, `cloud-utils-growpart` å°Žå…¥
- clout-initãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ« `/etc/cloud/cloud.cfg` æ›¸ãæ›ãˆ
- cloud-initãŒé©ç”¨ã•ã‚Œãªã„ã‚ˆã† `/etc/cloud/cloud-init.disabled`(ç©º) ãŠã‚ˆã³ `/etc/cloud/cloud.cfg.d/99-template-maint.cfg` ã‚’é…ç½®:  
  ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆVMã®ä¿å®ˆã¨é‡ç”£æ¯ä½“ã¨ã—ã¦ã®ä¸¡ç«‹ãŒå¯èƒ½ã«ã€‚å½“ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã†ã¡ã¯é€šå¸¸ã®VMã¨ã—ã¦èµ·å‹•ã§ãã‚‹ã€‚ï¼ˆâ‡’ ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚¯ãƒ­ãƒ¼ãƒ³ä¸Šã‹ã‚‰å‰Šé™¤ï¼‰

**â€”â€” ã“ã‚Œã‚ˆã‚Šã€åŸºæœ¬çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ cloudinit-linux-vm-deploy.ps1 ã«ã‚ˆã‚Šé€²ã‚ã‚‹ â€”â€”**  

### ðŸŽ¯ cloudinit-linux-vm-deploy.ps1 ã®ä»•æ§˜éª¨å­

â˜‘ï¸ **cloudinit-linux-vm-deploy.ps1 ã¯3ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆ:**  
`-Phase` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒªã‚¹ãƒˆå€¤ã§ã‚ã‚Šè¤‡æ•°æŒ‡å®šå¯ï¼‰ã«ã‚ˆã‚Š **é€šã—ã§å…¨è‡ªå‹•**ï¼**ç‰¹å®šã®ãƒ•ã‚§ãƒ¼ã‚ºã®ã¿å®Ÿè¡Œ** ã®é¸æŠžãŒå¯èƒ½ã€‚ã‚„ã‚Šç›´ã—ã‚‚å®¹æ˜“ã€‚`2,1`ã®ã‚ˆã†ã«é †åºã‚’ä¹±ã—ã¦æŒ‡å®šã•ã‚Œã¦ã‚‚å¸¸ã«æ˜‡é †ã§å®Ÿè¡Œã€‚`1,3`ã¨ã„ã†é£›ã³çŸ³ã¯ã‚¨ãƒ©ãƒ¼æ‰±ã„ã€‚

â˜‘ï¸ å„ãƒ•ã‚§ãƒ¼ã‚ºã§è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥é™ã®å‡¦ç†ã‚’è‡ªå‹•å®Ÿè¡Œã—ãªã„ã€‚

â˜‘ï¸ **VMè‡ªå‹•èµ·å‹•/è‡ªå‹•åœæ­¢æ©Ÿèƒ½ã«ã¤ã„ã¦:**  
å‹æ‰‹ã«èµ·å‹•ã‚„ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã—ã¦ã»ã—ããªã„å ´åˆã‚‚ã‚ã‚‹ã€‚`-NoRestart` ã‚¹ã‚¤ãƒƒãƒã‚’æŒ‡å®šã™ã‚‹ã¨ã€ä¸‹è¨˜ãƒ•ã‚§ãƒ¼ã‚ºæ¦‚è¦ä¸­ã® âš¡ ãƒžãƒ¼ã‚¯ã®ã¨ã“ã‚ã®èµ·å‹•ï¼åœæ­¢ã¯è¡Œã‚ã‚Œãªã„ã€‚  
**â—ä¾‹å¤–:** è¤‡æ•°ãƒ•ã‚§ãƒ¼ã‚ºæŒ‡å®šï¼ˆä¾‹: `-Phase 1.2,3`ã‚„ `1,2`, `2,3`ï¼‰ã•ã‚ŒãŸå ´åˆã«ã¯ã€è‡ªå‹•èµ·å‹•ãƒ»è‡ªå‹•åœæ­¢ãªã—ã«ã¯ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒæˆç«‹ã—ãªã„ãŸã‚ã€`-NoRestart`ã¯ç„¡è¦–ã™ã‚‹ã‚‚ã®ã¨ã™ã‚‹ã€‚ã“ã®ä¾‹å¤–ã«åˆè‡´ã—ãŸå ´åˆã«ã¯ã€æœ€åˆã®ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹ã™ã‚‹ä»¥å‰ã«ã€"ç¶šè¡Œã™ã‚‹ã‹å¦ã‹(y/[N])" ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æŒ‡ç¤ºã‚’ä»°ã â‡ Nã®å ´åˆã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã‚¢ãƒœãƒ¼ãƒˆã€‚  
- ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºæœ€åˆã®ãƒ–ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã¯å¿…é ˆãªã®ã§ç„¡ã—ã«ã¯ã§ããªã„ã®ã§ã€ä¸€æ™‚åˆ‡ã‚Šæ›¿ãˆã‚’å¯èƒ½ã¨ã™ã‚‹ãŸã‚`Start-MyVM`ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã« `-Force` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è£…å‚™ã™ã‚‹ã€‚

â˜‘ï¸ **ãƒ­ã‚°ã‚„ä¸­é–“ç”Ÿæˆç‰©(user-dataãƒ•ã‚¡ã‚¤ãƒ«ãªã©)ã®å‡ºåŠ›å…ˆ:**  
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ç›´ä¸‹ã«æˆæžœVMã®VMåãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œã‚Šãã“ã«å‡ºåŠ›ã™ã‚‹ã€‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆçµ‚äº†æ™‚ã«ã‚‚è‡ªå‹•å‰Šé™¤ã¯ã›ãšã€ã€Œcloud-init seedãŒ "$path" ã«ä½œã‚‰ã‚ŒãŸã€æ—¨ã‚’è¡¨ç¤ºã™ã‚‹ã€‚  
ãƒ­ã‚°ã¯å¸¸ã«è¿½è¨˜ã€‚user-dataãªã©cloud-init seedãƒ•ã‚¡ã‚¤ãƒ«é¡žã¯è­¦å‘Šãªã—ã«ä¸Šæ›¸ãã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç­‰ã¯ä½¿ç”¨è€…è²¬ä»»ã¨ã™ã‚‹ã€‚

â˜‘ï¸ **ãƒ­ã‚°ãŠã‚ˆã³ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ:**  
ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚¨ãƒ©ãƒ¼ä¸­æ­¢ã¨ãªã£ãŸéš›ã«ã€ã‚¨ãƒ©ãƒ¼ãƒ¶æ‰€ã¨åˆ°é”å‡¦ç†ä½ç½®ãŒåˆ†ã‹ã‚‹ã‚ˆã†ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼ˆã‚„ã‚„ç°¡ç•¥ã«ï¼‰ãŠã‚ˆã³ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚ˆã‚Šã¯è©³ç´°ï¼‰ã¸ã®æƒ…å ±å‡ºåŠ›ã‚’è¡Œã†ã€‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã¯ä¾‹ãˆã°  
```powershell
function Write-Log {
    param (
        [string]$Message
    )
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$Timestamp - $Message" | Out-File -Append -FilePath $LogFilePath -Encoding UTF8
}
```
ï¼¿ã¨ã„ã£ãŸãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã«ã¾ã¨ã‚ã‚‹ã€‚(ãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ã¯å¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚ã‚Š)

â˜‘ï¸ æˆæžœVMæ¯Žã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€cloud-initã¨ã®è¦ªå’Œæ€§ã‚‚é«˜ãã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å–ã‚Šè¾¼ã‚å€¤ã®å–ã‚Šå‡ºã—ã‚‚ã—ã‚„ã™ã„YAMLå½¢å¼ã¨ã™ã‚‹ã€‚ãã®ãŸã‚ã€ç®¡ç†ã‚µãƒ¼ãƒã®PowerShell(v5.x)ç’°å¢ƒã«`powershell-yaml`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å°Žå…¥ã‚’è¦ä»¶ã¨ã™ã‚‹ã€‚å°åž‹ã®ãŸã‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é…å¸ƒã‚‚ä½Žè² æ‹…ã€‚ï¼ˆPowerShell v7.5ç’°å¢ƒã§ã¯æ¨™æº–æ©Ÿèƒ½ã§ã‚ã‚Šè¿½åŠ ä¸è¦ï¼‰

â˜‘ï¸ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã¯3ãƒ•ã‚§ãƒ¼ã‚ºã™ã¹ã¦ã®å€¤ã‚’ç¶²ç¾…ã—ã€æˆæžœVM 1å°ã«ã¤ã1ãƒ•ã‚¡ã‚¤ãƒ«: ç®¡ç†ãƒ»é››å½¢åŒ–ãŒå®¹æ˜“

â˜‘ï¸ ç¬¬1, 2, 3 ãƒ•ã‚§ãƒ¼ã‚ºã®å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯ã¯ãã‚Œãžã‚ŒFunctionåŒ–ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã® switch åˆ†å²ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£å†…ã‹ã‚‰ã€ãã‚Œã‚‰ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã€‚ãŸã ã—ã€ã„ãšã‚Œã‹ã®ãƒ•ã‚§ãƒ¼ã‚ºãŒéžå¸¸ã«çŸ­ã„ã‚³ãƒ¼ãƒ‰ã§çµ‚ã‚ã‚‹è¦‹è¾¼ã¿ã«ãªã£ãŸå ´åˆã€ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ£å†…ã«ç›´æŽ¥ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã“ã¨ã‚‚æ¤œè¨Žå¯ã€‚

â˜‘ï¸ ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºã®åˆæœŸåŒ–ã‚³ãƒžãƒ³ãƒ‰ã®å†…å®¹ã¯ `init-vm-cloudinit.sh` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç‹¬ç«‹ã—ã¦ã„ã‚‹ãŸã‚ã€è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ã®è‡ªå‹•å®Ÿè¡Œã®ä»–ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦è»¢é€ã—ã¦ã®æ‰‹å‹•å®Ÿè¡Œã‚„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã¸ã®ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆãªã©ã«ã‚‚æŸ”è»Ÿã«å¯¾å¿œ

â˜‘ï¸ ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºã®cloud-init seedãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`user-data`ç­‰ï¼‰ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚‚åˆ¥ä½“ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã§ã€é©æ™‚ä¿®æ­£ã—ã‚„ã™ãã€Git/å±¥æ­´ç®¡ç†ã‚„å¤šç’°å¢ƒå±•é–‹ã«ã‚‚å¼·ã„ã€‚

â˜‘ï¸ ISOä½œæˆã«ã¯ã€mkisofsã®win32ç‰ˆã‚’ä½¿ç”¨ã™ã‚‹ã€‚[cdrtfe](https://sourceforge.net/projects/cdrtfe/) ã«å«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’å–ã‚Šå‡ºã—ã¦é…ç½®(ç½®ãã ã‘â€”ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦)ã€‚æˆ‘ã€…ã®é–‹ç™ºç’°å¢ƒã«ãŠã„ã¦ã¯ã€å¿…è¦æœ€å°é™è¿‘ãã¾ã§å°æ§‹æˆã«ã—ãŸã‚‚ã®ã‚’cdrtfe-1.5.9.1-mini.zipã¨ã—ã¦ã§ç¢ºä¿ã—ã€ã“ã‚Œã‚’é…å¸ƒç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã™ã‚‹(mkisofsã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³3.02a10ãƒ»ISOã®æ§‹æˆç‚¹æ¤œã«ä¾¿åˆ©ãª `isoinfo.exe` ã‚‚æ®‹ã—ãŸ)ã€‚è¨­è¨ˆä¸Šã®ã€å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¯ `C:\work\cdrtfe\tools\cdrtools\mkisofs.exe` ã§ã‚ã‚‹ã‚‚ã®ã¨ã™ã‚‹ãŒã€å¤‰æ•°ã§ç°¡å˜ã«èª¿æ•´å¯èƒ½ã«ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¬¡ç¬¬ã§ä»–ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ (ä¸‹è¨˜ è¨»)ã«æ›¿ãˆã‚‹ã“ã¨ã‚‚æƒ³å®šã™ã‚‹ã€‚  
ðŸ“ Windws server 2022ä»¥é™ãªã‚‰WSL2ã§ãƒŸãƒ‹ubuntu LinuxãŒç°¡å˜ã«å‹•ã‹ã›ã€ãã®å†…éƒ¨ã« `genisoimage`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°ä¿¡é ¼æ€§ã‚‚é«˜ã„ã€‚

â˜‘ï¸ **vCenter Serverã¸ã®æŽ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã«ã¤ã„ã¦:**  
- å®Ÿç¸¾ã®ã‚ã‚‹ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ `VIConnect` ãŒã‚ã‚‹ã®ã§ãã®ã‚³ãƒ¼ãƒ‰æ´»ç”¨ã€‚
- æŽ¥ç¶šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ(ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ã‚‚)ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã§æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€äº‹å‰ã«`New-VICredentialStoreItem`ã§ç®¡ç†ã‚µãƒ¼ãƒä¸Šã«ç™»éŒ²ã—ã¦ã‚ã‚‹ã‚‚ã®ã¨è§£é‡ˆã™ã‚‹ã€‚
- æŽ¥ç¶šãƒªãƒˆãƒ©ã‚¤ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãŒã€ãƒªãƒˆãƒ©ã‚¤å›žæ•°ãŠã‚ˆã³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã¯å›ºå®šã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«æ±‚ã‚ãªã„ã€‚ãŸã ã—ã€å¤‰æ›´ã‚‚ã—ã‚„ã™ã„ã‚ˆã†å¤‰æ•°åŒ–ã¯ã™ã‚‹(ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†’é ­ä»˜è¿‘ã§)ã€‚

â˜‘ï¸ PSã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ˜ãƒƒãƒ€ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã€ç§ã®æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«è¿‘ã„ã‚‚ã®ã«ã™ã‚‹ã€‚ã‚ã¨ã§ã‚µãƒ³ãƒ—ãƒ«ã‚’æä¾›ã™ã‚‹ã€‚

### ç¬¬1ãƒ•ã‚§ãƒ¼ã‚º

1. **è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ cloudinit-linux-vm-deploy.ps1 ã«ã‚ˆã‚Š:** ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å€¤ã«å¿œã˜ã¦CPUæ•°ã€ãƒ‡ã‚£ã‚¹ã‚¯ã‚µã‚¤ã‚ºãªã©ã‚’ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºã—ãŸã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ  
   ãã®ã‚ã¨ã®è‡ªå‹•èµ·å‹•ã¯ã—ãªã„ã€‚

### ç¬¬2ãƒ•ã‚§ãƒ¼ã‚º

1. ã‚¯ãƒ­ãƒ¼ãƒ³VMã‚’èµ·å‹•ï¼ˆèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèµ·å‹•(`-NoRestart`ãƒ•ãƒ©ã‚°ã«é–¢ã‚ã‚‰ãš)
2. OSã¨ã—ã¦ & cloud-initã¨ã—ã¦ã®åˆæœŸåŒ–ã€ã‚µãƒ–ã‚¹ã‚¯ã‚¯ãƒªã‚¢ã€`99-template-maint.cfg`ã®å‰Šé™¤ã€`99-override.cfg`ã®é…ç½®ãªã©
3. ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³(âš¡)

ðŸ“ åˆæœŸåŒ–ã‚³ãƒžãƒ³ãƒ‰ã¯ `init-vm-cloudinit.sh` ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç‹¬ç«‹ã—ã¦ã„ã‚‹ãŸã‚æ‰‹å‹•å®Ÿè¡Œã‚‚ã—ã‚„ã™ãã€ã“ã®ãƒ•ã‚§ãƒ¼ã‚ºã¯å®Œå…¨ã«æ‰‹å‹•ã§è¡Œã†ã“ã¨ã‚‚å¯èƒ½

### ç¬¬3ãƒ•ã‚§ãƒ¼ã‚º

1. è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã«å¾“ã£ã¦ `user-data` ç­‰ cloud-initã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆYAMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”Ÿæˆã—ã€ãã‚Œã‚‰ã‚’å«ã‚€cloud-init seed ISOã‚’ä½œæˆãƒ»ã‚¯ãƒ­ãƒ¼ãƒ³VMã«ãƒžã‚¦ãƒ³ãƒˆ
2. ã‚¯ãƒ­ãƒ¼ãƒ³VMã‚’èµ·å‹•(âš¡) â‡’ cloud-initã«ã‚ˆã‚‹å›ºæœ‰åŒ–ï¼ˆãƒªã‚½ãƒ¼ã‚¹é‡ã€å„ãƒ‡ã‚£ã‚¹ã‚¯æœ€çµ‚ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®æ‹¡å¼µãªã©ï¼‰ãŒç™ºå‹•

---

## ðŸš€ åˆ¶ä½œç‰©ãƒ»å·¥ç¨‹ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆãƒªã‚¹ãƒˆ

### âš™ï¸ A. æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºãƒ»ã‚¤ãƒ³ãƒ•ãƒ©

- **Template VM æœ¬ä½“**
    - cloud-init, cloud-utils-growpart ãªã©å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«  
    - `/etc/cloud/cloud-init.disabled`(ç©ºãƒ•ã‚¡ã‚¤ãƒ«)ã®ä½œæˆ  
    - `/etc/cloud/cloud.cfg`ã®ä¿®æ­£  
    - `/etc/cloud/cloud.cfg.d/99-template-maint.cfg`ä½œæˆ

- **PowerShell ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« ï¼ˆç®¡ç†ãƒ»ä½œæ¥­ã‚µãƒ¼ãƒã«é…ç½®ï¼‰**
    - powershell-yaml : `install-module`ã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¾ãŸã¯ã€ãƒ•ã‚©ãƒ«ãƒ€ä¸€å¼ã‚’zipç­‰ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆã”ãè»½é‡ãªã®ã§ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é…å¸ƒã‚‚ç°¡å˜ï¼‰  
      ðŸ“Œ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç›®å®‰ã¯ä»Šå¾Œå®Ÿæ©Ÿã«ã¦ç¢ºèªã€PSè‡ªä½“ã€PowerCLIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ã€æ¤œè¨¼æ¸ˆã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‹READMEã§è§¦ã‚Œã‚‹ã“ã¨ã‚‚æ¤œè¨Ž

---

### âš™ï¸ B. ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### ðŸ“‹ ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ¬ä½“ï¼ˆãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹æ§‹æˆãƒ»ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿ã‚¹ã‚¤ãƒƒãƒä»˜ï¼‰
- `cloudinit-linux-vm-deploy.ps1`
    - `-Phase` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§1,2,3ã®æŒ‡å®šï¼ˆãƒªã‚¹ãƒˆåž‹å¼•æ•°ï¼‰
    - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆ`-Config` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    - `-NoRestart` ã‚ªãƒ—ã‚·ãƒ§ãƒ³

#### ðŸ“‹ ãƒ•ã‚§ãƒ¼ã‚ºå…±é€šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆYAMLå½¢å¼ã€1VMæ¯Žã«1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
- `vm-settings.yaml` â† è¦‹æœ¬`vm-settings_example.yaml`ã¨ã—ã¦æä¾›
   - **1. ã‚¤ãƒ³ãƒ•ãƒ©ç³»**  
      vCenterãƒ›ã‚¹ãƒˆå/IP, æŽ¥ç¶šç”¨ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãªã©
   - **2. VMãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ç³»**  
      ã‚½ãƒ¼ã‚¹Templateå, ã‚¯ãƒ­ãƒ¼ãƒ³VMåå‰, vCPU, ãƒ¡ãƒ¢ãƒª, ãƒ‡ã‚£ã‚¹ã‚¯, ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ©ãƒ™ãƒ«, ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚¯ãƒ©ã‚¹ã‚¿&ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ãªã©
   - **3. VM OSå†…éƒ¨**  
      ãƒ›ã‚¹ãƒˆå, IPã‚¹ãƒšãƒƒã‚¯, SSHå…¬é–‹éµ, cloud-initã§ä½¿ã†å„ç¨®è¨­å®šå€¤ãªã©  

    ðŸ“Œ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å¿…é ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ•ã‚©ãƒ«ãƒ€(`{{..}}`)ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚„READMEãªã©ã§è§£èª¬ã®äºˆå®š

#### ðŸ“‹ ç¬¬2ãƒ•ã‚§ãƒ¼ã‚ºç”¨ï¼šVMåˆæœŸåŒ–ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `init-vm-cloudinit.sh`
   ```bash
   #!/bin/sh -x
   subscription-manager clean
   subscription-manager remove --all
   cloud-init clean
   truncate -s0 /etc/machine-id
   rm -f /etc/cloud/cloud.cfg.d/99-template-maint.cfg /etc/cloud/cloud-init.disabled
   # Create /etc/cloud/cloud.cfg.d/99-override.cfg for the clone
   cat > /etc/cloud/cloud.cfg.d/99-override.cfg <<EOM
   preserve_hostname: false
   manage_etc_hosts: false
   EOM 
   ```

- è‡ªå‹•åŒ–ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ã“ã‚Œã‚’VMå†…ã§`Invoke-VMScript`ã§å®Ÿè¡Œã™ã‚‹

#### ðŸ“‹ ç¬¬3ãƒ•ã‚§ãƒ¼ã‚ºç”¨ï¼šcloud-initãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- `user-data_template.yaml`
- `meta-data_template.yaml`
- `network-config_template.yaml`  
è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã“ã‚Œã‚‰é››å½¢ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å…±é€šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®å€¤ã§ç½®æ›ã—ã¦å›ºæœ‰åŒ–ã—ã€ã‚­ãƒƒãƒˆã®spoolãƒ•ã‚©ãƒ«ãƒ€ã« cloud-init seedãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹  

ðŸ“Œ åŸºæœ¬å½¢ã¯ä¸Šè¨˜ã®3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`original/`ãƒ•ã‚©ãƒ«ãƒ€ã«åŽå®¹ã€‚ä»–ã«æ¯”è¼ƒçš„ä½¿ç”¨é »åº¦ã®é«˜ã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã€å¯èƒ½ãªç¨‹åº¦ã¾ã§ã¯ã“ã‚Œã‚‰ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ãŸå½¢ã§ä½µè¨˜ã€‚ãã®ç¯„å›²ã«åŽã¾ã‚‰ãªã„å ´åˆã¯ã€åˆ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç”¨æ„ã—ã¦æ ¼ç´ï¼ˆä¾‹: `minimal/`, `multinic/`ï¼‰ã€‚ç¶²ç¾…äºˆå®šã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€™è£œ:  
- ãƒžãƒ«ãƒNIC  
- è¤‡æ•°sshkeyç™»éŒ²
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼

ðŸ“Œ VM OSã¯ RHEL9 ã‚’å‰æã¨ã—ã¦é–‹ç™ºã€‚  
- Networkã¯æ¨™æº–ã®NetworkManagerã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¨ã™ã‚‹
- SELinuxã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Enforcingã®ã¾ã¾ã¨ã—ã€ã¨ãã«cloud-initã§ã¯ã„ã˜ã‚‰ãªã„ã€‚Permissiveã‚„Disableã«ã™ã‚‹å ´åˆã¯ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«å®Ÿæ©Ÿä¸Šã§æ‰‹å‹•ã§å¤‰æ›´ã™ã‚‹ã®ãŒç¢ºå®Ÿ

---

### âš™ï¸ C. è£œåŠ©ãƒ•ã‚¡ã‚¤ãƒ«

- `README.md`  
    - é‹ç”¨æ‰‹é †ãƒ»è¨­è¨ˆæ„å›³ã¾ã¨ã‚

---

